<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="style.css">
    <link rel="apple-touch-icon" href="iconV2.png">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <script src="https://www.gstatic.com/firebasejs/5.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.1/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.1/firebase-firestore.js"></script>
    <script src="jquery.min.js"></script>
    <script src="main.js"></script>
    <title>トークン招き猫</title>
    <style>.fukidashi{width:400px;word-wrap:break-word;}</style>
  </head>
  <body>
    <div class="container">
      <div class="fukidashi">トークンです</div>
      <div class="fukidashi_fuchi">
        <img src="img/fukidashi_fuchi.png" alt="">
      </div>
      <img src="img/cat.png" alt="" class="cat">
    </div>

    <script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      var config = {
        apiKey: "AIzaSyCAQ_TOCtBTXel87hCCRdXy-L4eUPt1UFg",
        authDomain: "gcmproject-141802.firebaseapp.com",
        databaseURL: "https://gcmproject-141802.firebaseio.com",
        projectId: "gcmproject-141802",
        storageBucket: "gcmproject-141802.appspot.com",
        messagingSenderId: "961587936477"
      };
      firebase.initializeApp(config);
      const messaging = firebase.messaging();

      const db = firebase.firestore();
      const settings = {/* your settings... */ timestampsInSnapshots: true};    // コンソールに表示されたエラー内にこれを記述しろとあったので２行を追加
      db.settings(settings);
      // messaging.usePublicVapidKey("BPWCBg99aHovFOR5lL5HgCfUQzpMddA93M1ZRn_nQp621MfF_HMuyxyrhHG1yurJpYYY0PQ2-yFDOkjSQwBNa_c");

      /* ServiceWorker */
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./firebase-messaging-sw.js').then(registration => {
          console.log('SW registered');
          messaging.useServiceWorker(registration);
          messaging.requestPermission().then(() => {
            console.log('permission granted');
            messaging.getToken().then(token => {
                // console.log(token);
                msg02('トークンにゃ :\n '+ token);
                // トークン格納
                db.collection("tokens").add({
                  token: token
                })
                .then(function(docRef) {
                    console.log("Document written with ID: ", docRef.id);
                })
                .catch(function(error) {
                    console.error("Error adding document: ", error);
                });
                // トークンをトピックに登録
                var xhr = new XMLHttpRequest(); 
                var url = 'https://iid.googleapis.com/iid/v1/' + token + '/rel/topics/slc';
                console.log(url);
                xhr.open('POST', url);
                xhr.setRequestHeader('content-type', 'application/json');
                xhr.setRequestHeader('Authorization', 'key=AAAA3-MbfN0:APA91bGtlCrxRI-_F6tEZOAW-ebhX5_39F3DiAnwK7wRlsL9dd7bWylNtc3AhzQmaNVVJnLcX2D1l7wVEGjyk1yn3gfKQwW57uJ7Qq7DQzfUJ67zeSeK5cjuEBBRK9SZRZTuDTyzrxUF');
                xhr.send();
                xhr.onreadystatechange = function() {
                  console.log( xhr.responseText );
                  // console.log('xhr.readyState:' + xhr.readyState)
                  // if(xhr.readyState === 4 || xhr.status === 2 || xhr.status === 3) {
                  //   console.log( xhr.responseText );
                  // }else{
                  //   console.log(' xhr error')
                  // }
                }
            });
          });

          // Callback fired if Instance ID token is updated.
          messaging.onTokenRefresh(function() {
            messaging.getToken().then(function(refreshedToken) {
              console.log('Token refreshed.');
              // Indicate that the new Instance ID token has not yet been sent to the
              // app server.
              // setTokenSentToServer(false);
              // Send Instance ID token to app server.
              // sendTokenToServer(refreshedToken);
              // ...
            }).catch(function(err) {
              console.log('Unable to retrieve refreshed token ', err);
              // showToken('Unable to retrieve refreshed token ', err);
            });
          });

        }).catch(error => {
          console.error(error);
        });
      }
    })
      // function requestPermission(){
      // //プッシュ通知の許可をする処理
      //   console.log('Requesting permission...');
      //   // [START request_permission]
      //   messaging.requestPermission().then(function() {
      //     console.log('Notification permission granted.');
      //     // TODO(developer): Retrieve an Instance ID token for use with FCM.
      //     // [START_EXCLUDE]
      //     // In many cases once an app has been granted notification permission, it
      //     // should update its UI reflecting this.
      //     viewToken();
      //     // [END_EXCLUDE]
      //   }).catch(function(err) {
      //     console.log('Unable to get permission to notify.', err);
      //   });
      //   // [END request_permission]
      // }


      // function viewToken(){
      //   messaging.getToken().then(function(currentToken) {
      //     console.log('currentToken:' + currentToken )
      //     if (currentToken) {
      //       msg02('トークンにゃ : '+ currentToken);//フキダシにトークンを表示。functionはmain.jsに定義。
      //     } else {
      //       // Show permission request.
      //       console.log('No Instance ID token available. Request permission to generate one.');
      //       // Show permission UI.
      //       updateUIForPushPermissionRequired();
      //       setTokenSentToServer(false);
      //     }
      //   }).catch(function(err) {
      //     console.log('An error occurred while retrieving token. ', err);
      //     showToken('Error retrieving Instance ID token. ', err);
      //     setTokenSentToServer(false);
      //   });
      // }

      // requestPermission();

  </script>

  </body>
</html>
